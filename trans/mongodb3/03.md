# 第三章蒙古贝壳

开发人员可能会首先尝试了解如何运行查询和管理数据库。

MongoDB 自带一套实用程序，全部安装在 **bin** 文件夹中。其中一个实用程序是`mongo.exe`，也被称为“mongo shell”，这是一个到数据库的交互式 JavaScript 接口。mongo shell 用于查询或操作数据，以及执行管理操作。

要启动 mongo shell，我们只需在命令提示符下键入`mongo`。显然，为了让 shell 工作，数据库必须启动并运行。

代码清单 13:启动 Mongo Shell

```
  C:\mongodb\bin>mongo
  MongoDB shell version v3.4.1
  connecting to: mongodb://127.0.0.1:27017
  MongoDB server version: 3.4.1

```

一旦进入 shell，我们就自动连接到本地机器(localhost)上的数据库实例，根据定义，使用默认端口 27017。

| ![](../Images/tip.png) | 提示:通过在系统变量路径中包含 c:\mongodb\bin 目录，在整个系统中引用 mongodb 实用程序要容易得多。 |

如果数据库不在本地机器上(在任何生产系统中几乎总是如此)，我们可以指定远程服务器名称(`--host`)、端口以及用户名和密码，如下例所示:

代码清单 14:连接到 MongoDB 远程服务器

```
  C:\mongodb\bin>mongo --host
  <remoteServerName> --port 27017 –-u <username> --p
  <password>

```

默认情况下，MongoDB 没有默认用户或密码。这些可以通过`db.createUser`命令创建。

## 寻求帮助

在 mongo shell 中可以做的第一件事就是查看帮助，只需在 shell 中键入`help`即可获得帮助。帮助将带来各种对象(如数据库、集合、用户等)上可用命令的列表。

![](../Images/image014.jpg)

图 10:显示帮助。

当您键入`db.help()`时，将显示数据库对象上所有可用的操作。同样的逻辑也适用于其他对象。

![](../Images/image015.png)

图 11:显示数据库级别的帮助。

## 数据库

MongoDB shell 没有明确提供创建数据库的命令。当您向集合中插入至少一个文档时，如果不存在数据库，MongoDB 将创建一个数据库。

首先，让我们看看如何通过运行`show dbs`命令来获取 MongoDB 中的数据库列表:

![](../Images/image016.jpg)

图 12:获取数据库列表。

在新安装的 MongoDB 中，只有一个数据库，叫做**本地**。每个`mongod`实例都有自己的**本地**数据库，该数据库存储复制过程中使用的数据以及其他特定于实例的数据。

您可能还会看到一个`admin`数据库，这取决于是否应用了安全性。`admin`数据库将保存关于用户和密码的信息。就我而言，没有任何安全措施。

### 数据库创建

为了玩一玩 shell，我们将通过尝试插入一个文档来创建一个名为`mydb`的数据库。此操作将使 MongoDB 创建一个数据库。要导航到我们的新数据库，使用`use mydb`命令。即使数据库还不存在，shell 也会允许我们切换到它。

因此，作为练习，让我们在`users`集合中的`mydb`数据库中插入一个虚构的用户条目:

代码清单 15:插入一个新文档

```
  db.users.insert({firstname:
  'john', lastname: 'doe'})

```

如图 13 所示，结果显示`WriteResult({“nInserted” : 1 })`，告诉我们已经写了一行。目前一切顺利。

| ![](../Images/note.png) | 注意:插入文档将在以下章节中进一步解释。 |

作为最后一步，让我们再次运行`show dbs` 来检查数据库是否正在被创建:

![](../Images/image017.jpg)

图 13:通过将数据插入集合来创建数据库。

恭喜，您成功创建了第一个 MongoDB 数据库！

### 删除数据库

有时需要删除已经创建的数据库。MongoDB `db.dropDatabase()`命令用于此目的。

为了删除一个数据库，我们必须调用`use database`命令。一旦 shell 切换到选中的数据库，我们可以调用`db.dropDatabase()` 命令，这样会有效删除数据库。

![](../Images/image018.jpg)

图 14:删除数据库。

与前面的例子一样，当我们在集合中插入一个条目时，shell 返回命令的结果，告诉我们命令成功了。

## 收藏

当我们创建数据库时，我们插入了`users`集合中的第一个文档。要显示`users`集合在那里，我们可以使用命令`show collections`，这与用于显示数据库列表的命令非常相似。

![](../Images/image019.jpg)

图 15:显示集合列表。

我们可以看到`users`集合可用。

另一种方法是运行`db.getCollectionNames()`命令，然后返回一个 BSON 文档。

![](../Images/image020.jpg)

图 16:展示集合的另一种方式。

要创建集合，我们可以简单地运行以下命令(分号结束符对于单个命令是可选的):

代码清单 16:创建集合签名

```
  db.createCollection(name,
  options); 

```

`Name`是强制参数，`options`不是。有多种选项可以设置，如`capped`、`autoIndexId`、`size`；我们将在下一章探讨这些问题。

为了创建名为`person`的集合，我们需要运行以下命令:

代码清单 17:创建集合被调用人

```
  db.createCollection(“person”); 

```

要删除一个集合，我们只需调用`drop`，这将清空集合并将其从数据库中完全删除。

代码清单 18:删除人员集合

```
  db.person.drop(); 

```

![](../Images/image021.jpg)

图 17:创建和删除集合。

| ![](../Images/tip.png) | 提示:提醒一下:如果您需要知道在使用集合时哪些操作可用，您可以随时使用数据库来参考帮助。<collectionname>。help()命令，它将返回可用命令的列表。</collectionname> |

### 封顶系列

封顶集合是一种特殊的集合:固定大小的循环集合。

*   *固定大小*是指该表支持的最大项目数有一个预定义的(可配置的)限制。
*   *循环*是指一旦达到最大金额，最早的项目就会被删除，为新项目腾出空间。

有上限的集合的一个有趣的属性是，集合本身保留了插入项的顺序。这是一个非常重要的方面，特别是如果这种表被用于日志类型的问题，其中条目的顺序应该被保留。另一方面，它有一些限制:我们不能从有上限的集合中移除文档，并且如果更新或替换操作改变了文档大小，文档的更新将不起作用。

从图形上看，我们可以表示一个有上限的集合，如图 18 所示。

![](../Images/image022.png)

图 18:封顶集合。

封顶集合可用于多种目的，例如:

*   日志记录(例如，网站上执行的最新活动)。
*   缓存(保留最新项目)。
*   充当队列:有上限的集合也可以用作应用先进先出逻辑的队列。

#### 创建有上限的集合

封顶集合的创建方式与普通集合相同，但指定了选项参数:

代码清单 19:创建有上限的集合

```
  db.createCollection(“LogCollection”,
  { capped:true, size:10000, max:1000}) ; 

```

有 14 个可选参数。最常见的有三种:

*   `Capped` : `True`设置集合类型为封顶(默认为`false`)。
*   `Size`:设置此特定集合的最大大小(以字节为单位)。
*   `Max`:指定给定集合允许的最大文档数。

![](../Images/image023.jpg)

图 19:创建一个有上限的集合。

## 结论

在本章中，我们已经了解了 MongoDB shell 是什么，以及如何执行基本操作，例如创建数据库或集合，并对集合本身进行了更详细的介绍。

在接下来的章节中，我们将看到如何进一步使用 MongoDB 外壳。