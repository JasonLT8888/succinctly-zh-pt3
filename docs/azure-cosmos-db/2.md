# 第 2 章使用文档数据库的第一步

## 简介

在前一章中，我们大致了解了 DocumentDB、它的主要功能，以及在选择 NoSQL 数据库时为什么它是一个很好的选择，因为它具有大规模无缝扩展的能力。

在本章中，我们将探讨如何设置并准备好使用 DocumentDB，特别是如何创建 DocumentDB 帐户、数据库，然后创建我们的第一个集合。在这个初始设置之后，我们将更深入地查看集合，并向它们添加文档。

为了有数据供以后查询和使用，我们还将考虑使用文档数据库数据迁移工具将其他来源的数据导入到文档数据库中。这是了解数据如何从更传统的来源过渡到 NoSQL JSON 文档数据库的好方法。

在开始之前，需要注意的是，您需要一个微软帐户(通常与 Hotmail 或 Live 电子邮件帐户相关联)以及一个 Azure 订阅。听起来很令人兴奋，所以我们不要再等了，开始设置 DocumentDB 吧。

## DocumentDB 设置

启动和运行 DocumentDB 的第一步是在 Azure 上创建一个实例。如果您没有 Azure 帐户，您需要使用微软帐户注册 Azure。您可以通过访问[azure.microsoft.com](https://azure.microsoft.com/)然后点击页面顶部的**门户**选项来实现。

![](../Images/image001.png)

图 2-a:微软 Azure 登录屏幕

注册或登录 Azure 门户后，您可以浏览 Azure 服务列表并选择 **Azure 宇宙数据库**选项。

![](../Images/image002.png)

图 2-b:在 Azure 服务列表中浏览宇宙数据库

选择 **Azure 宇宙数据库**选项后，您必须通过点击**添加**来创建一个新的宇宙数据库账户。

![](../Images/image003.png)

图 2-c:添加宇宙数据库帐户的屏幕

这将出现一个屏幕，允许您输入宇宙数据库帐户的详细信息:**标识**、**应用编程接口**、**订阅**、**资源组**和**位置**。您可以选择您的帐户将托管在哪个 Azure 区域。

该标识是微软 Azure 中宇宙数据库帐户的唯一全局标识符。确保选择 **SQL (DocumentDB)** 作为 API。要完成帐户创建，请单击**创建**。

![](../Images/image004.png)

图 2-d:最终宇宙数据库帐户创建屏幕

一旦创建了宇宙数据库帐户，可以如下所示。

![](../Images/image005.png)

图 2-e:宇宙数据库帐户仪表板

在宇宙数据库中，数据存储在集合中。我们可以选择我们的平台，然后点击**创建‘物品’收藏**按钮开始。就我而言，我将使用。NET 代码，所以这是我将选择的平台。

一旦**物品**集合被创建，你将出现以下屏幕。

![](../Images/image006.png)

图 2-f:项目集合创建屏幕

您可以选择下载提供的示例应用程序，但我现在将跳过这一步。让我们点击**数据浏览器(预览)**选项来查看我们的项目集合。

![](../Images/image007.png)

图 2-g:宇宙数据库数据浏览器(预览)窗格

我们将在**数据浏览器(预览)**刀片上花费一点时间，因此它将是我们的主要起点。

使用 Azure 服务的一个缺点是用户界面不断变化。因此，当你读到这里时，用户界面可能会与这本电子书中的数字略有不同。然而，变化将是微小的，你将毫无困难地匹配你所看到的数字。

但是在我们开始添加文档和与 DocumentDB 交互之前，让我们快速回顾一下它的内部结构。

![](../Images/image008.png)

图 2-h: DocumentDB 内部结构(图片由微软 Azure 提供)

为了更好地理解这个图表，请注意，一个 Cosmos DB 帐户由一组数据库组成，每个数据库包含多个集合，每个集合可以包含存储过程、触发器、UDF、文档和相关附件。

数据库也有相关联的用户，每个用户都有一组访问各种其他集合、存储过程、触发器、UDF、文档或附件的权限。

虽然数据库、用户、权限和集合是系统定义的资源，具有众所周知的模式，但另一方面，存储过程、触发器、UDF 和附件包含任意的和用户定义的 JSON 内容。

在我的例子中，**fastapsdb**对应宇宙数据库账户， **ToDoList** 对应自动创建的 DocumentDB 数据库，该数据库是我之前点击**创建‘物品’收藏**按钮时创建的，而**物品**是创建的收藏。

![](../Images/image009.png)

图 2-i:包含项目集合的文档数据库

请注意，如果需要，您可以选择在现有的 DocumentDB 数据库上创建一个新集合，或者将其删除，然后创建一个新集合。现在，让我们保持现状。

## 创建新收藏

虽然我们现在不需要新的收藏，但知道如何创建收藏是很重要的。

只需点击**数据浏览器(预览)**刀片顶部的**新集合**按钮即可。

或者，也可以通过点击**省略号** ( **…** )按钮在数据库级别完成，这将出现一个小菜单，然后点击**新收藏**选项。

如果这样做，屏幕右侧将出现一个窗格，您可以在其中输入新收藏的名称。

![](../Images/image010.png)

图 2-j:添加集合窗格

一旦到达，指定将用于**集合 Id** 的唯一名称，然后根据需要更改**吞吐量**字段。您也可以添加一个**分区键**。您现在可以创建收藏了。让我们探索如何将文档添加到现有集合中。

## 添加文档

在**数据浏览器(预览)**刀片中，展开**项目**集合，然后选择**文档**选项。

![](../Images/image011.png)

图 2-k:集合的文档浏览器

点击**新建文档**按钮，**文档浏览器**窗口将变为编辑模式，并显示一个模板 JSON 文档。删除默认的 JSON 数据，并输入以下信息。

![](../Images/image012.png)

图 2-1:用文档资源管理器创建新文档

这是一个简单的基于网络的文本编辑器，它不强制执行任何规则，允许您向其中添加几乎任何原始数据。

我们正在创建一个 JSON 文档，它基本上具有我们想要的任何属性。一旦完成，我们所要做的就是点击**保存**，我们的文档将存储在集合中。

请注意，已经提供了一个唯一的`id`，并且它在集合中的所有文档中必须是唯一的。如果您没有提供唯一的`id`，DocumentDB 将使用 GUID 自动创建一个。

唯一的`id`属性必须始终是不超过 255 个字符的`String`。不能是一个`Number`、`Date`、`Time`、`Boolean`，也不能是另一个`object`。

这就是在 Azure 门户中为文档数据库集合创建 JSON 文档的全部内容。很简单。

## 数据迁移到文档数据库

将数据导入文档数据库的一个很好的方法是从传统的关系数据源(如 SQL Server)中导入数据。然而，这不是唯一的方法。

开源项目 [DocumentDB 数据迁移工具](https://github.com/azure/azure-documentdb-datamigrationtool)允许您精确地实现这一点。二进制文件可以从[这里](https://www.microsoft.com/en-us/download/details.aspx?id=46436)下载。

此外，该工具不仅允许您从 SQL Server 导入数据，还允许您从各种其他来源导入数据，例如 Azure Table 存储、JSON 文件、MongoDB、CSV 文件、RavenDB、Amazon DynamoDB、HBase，甚至从其他 DocumentDB 数据库。很方便。

让我们下载这个工具，然后运行它。二进制文件被打包成 zip 文件。下载后，只需解压缩到任何文件夹。

![](../Images/image013.png)

图 2-m:文档数据库数据迁移工具二进制文件

解压后，找到名为**dtui.exe**的文件并运行。然后，您将看到以下屏幕。

![](../Images/image014.png)

图 2-n:文档数据库数据迁移工具欢迎屏幕

文档数据库数据迁移工具非常直观且易于使用。单击**下一步**，系统将要求您选择要导入的源。然后指出检索数据所需的连接参数。

在本例中，我们将从 Azure 表中导入数据。

![](../Images/image015.png)

图 2-o:在文档数据库数据迁移工具中选择导入源

将**连接字符串**填写到 Azure 存储表(可以从 Azure 管理仪表盘中复制)、Azure 表的表名中，如果不想填写任何其他字段，请单击**下一步**。

![](../Images/image016.png)

图 2-p:文档数据库数据迁移工具的目标信息

完成后，点击**下一步**继续。您将查看整体迁移信息并完成数据迁移过程。

考虑到从各种数据源导入数据的多种可能性，请务必仔细检查源和目标信息是否正确，以便数据迁移工具能够正确执行其工作。

数据迁移工具是将数据放入 DocumentDB 并开始使用的便捷方法。这也是将标准的 SQL Server 数据库系统中的数据获取到 DocumentDB 中的好方法。这是一个非常容易使用的工具，只需要很少的实验就能做好。利用好它。

## 总结

在这短短的一章中，我们已经完成了启动和运行 DocumentDB 以及导入数据所需的一些基本步骤。

我们已经看到了如何创建一个 DocumentDB 数据库和一个集合，并向其中添加数据。我们还研究了创建集合时与性能级别相关的不同定价层。

在下一章中，我们将使用非常熟悉的 SQL 风格的语法来研究使用 DocumentDB 来运行数据查询。接下来，我们将探索直接在 DocumentDB 服务器上构建客户端应用程序和程序。

真正的乐趣即将开始。感谢阅读！