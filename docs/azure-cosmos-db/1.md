# 一、文档数据库基础

## 简介

DocumentDB，顾名思义，将数据存储为“文档”，实际上是 JSON 对象。

在关系数据库中，记录以行的形式存储在具有特定列的表上，使用的是已定义的模式。然而，在文档存储中，记录就是文档，每个记录都包含特定的属性，没有模式限制。

为了理解关系数据库和文档数据库之间的区别，让我们考虑下表。

表 1-a:关系数据库和文档数据库的主要区别

| 关系数据库 | 文档数据库 |
| 行 | 文档 |
| 列和数据类型 | 性能 |
| 强类型和定义的架构 | 无模式 |
| 高度标准化 | 大部分是非规范化的 |
| 健壮成熟 | 简单而精干 |
| 垂直扩展(更多硬件) | 横向扩展 |

关系数据库表具有固定的结构，为了对表进行更改，例如添加新列、更改特定列以允许空值或更改数据类型，有必要修改表的架构，这可能会对表中已经存储的现有数据产生副作用。

因为 DocumentDB 是无模式的，所以它不受关系数据库的约束。在当今世界，应用和软件开发与频繁发展的数据模式相关联，文档数据库是一个很好的匹配。

让我们看看一些示例数据如何存储在传统的关系表中，以及如何存储在文档数据库中。

表 1-b:存储在关系数据库表中的示例数据

| 西方人名的第一个字 | 姓 | 年龄 | 活跃的 |
| --- | --- | --- | --- |
| 约翰 | 母鹿 | forty-four | 活跃的 |
| 克里斯蒂亚诺 | 罗纳尔多 | Thirty-one | 空 |
| 彼得（男子名） | 平底锅 | Sixty-seven | 退休的 |

正如我们所看到的，数据是以表格格式构造的，所有记录都有相同数量的列。请注意，为了简单起见，我使用了“年龄”列；在真实的数据库中，我会使用出生日期列。

但是，请考虑用黄色突出显示的记录。此记录在“名字”、“姓氏”和“年龄”列中有值，但“活动”列没有值；因此，它被设置为空。与黄色记录相反，其他记录的所有列中都有值。

尽管表格格式可以容纳不一定在相同数量的列中具有值的记录(通过在没有值的列中使用空值)，但它仍然要求这些记录具有该列，因为架构强制要求这样做。

如果我们要在一个非关系文档数据库(如 DocumentDB)中容纳同样的数据，它将如下所示。

表 1-c:存储在非关系文档数据库中的示例数据

| 文件 | 文档数据 |
| one | {“名字”:“约翰”，“LastName”表示“do”，【年龄】:44，“活动”:“活动”} |
| Two | {“名字”:“克里斯蒂亚诺”，“姓氏”:“罗纳尔多”，【年龄】:31 岁} |
| three | {“名字”:“彼得”，“姓”:“潘”，【年龄】:67，“活动”:“已退休”} |

仅出于说明目的，上一个表中的数据以表格格式显示，类似于关系数据库表使用的格式。然而，文档数据库并不以表格格式存储数据，而是作为 JSON 数据的二进制表示。

关系数据库上下文中所谓的表被称为文档数据库中的文档集合，或者简单地说，称为集合。

请注意，关系型和非关系型文档数据库的主要区别在于，在非关系型文档数据库中，记录被称为文档，它们只存储正在使用的属性值(对应于关系表中的列)。因此，空属性不需要在文档中表示，因为它们不是由模式强制执行的。

此外，非关系文档数据库允许文档存储子属性，这些子属性不能显式存储在关系表中。例如，将名字和姓氏属性替换为具有两个子属性的全名属性，这两个子属性称为名字和姓氏。

表 1-d:具有子属性的文档

| 文件 | 文档数据 |
| Two | {"全名"：{“第一”:“克里斯蒂亚诺”，“最后一个”:“罗纳尔多”},【年龄】:31 岁} |

这个例子展示了，通过拥有子属性，文档如何相对于同一集合中的其他文档不被规范化，但是文档数据库可以完美地适应这一点。

这意味着每个文档都可以有属性和子属性，而这些属性和子属性可能不一定存在于其他文档中，这允许存储数据的高度灵活性和非规范化。

## 主-细节嵌套属性

在非关系数据库中，主-细节关系是通过嵌套属性来定义的。在关系数据库中，实现这一点的唯一方法是在两个表之间建立主-细节关系，在它们之间共享一个公共字段。

让我们考虑这个关系数据库中主-细节关系的例子。

表 1-e:典型的主-细节关系数据库关系

| 西方人名的第一个字 | 姓 | 年龄 | 活跃的 | 球员 |
| 约翰 | 母鹿 | forty-four | 活跃的 | one |
| 克里斯蒂亚诺 | 罗纳尔多 | Thirty-one | 空 | Two |
| 彼得（男子名） | 平底锅 | Sixty-seven | 退休的 | three |

| 球员 | 团队名称 |
| Two | 皇家马德里 |
| Two | 曼联 |
| one | 火星银河足球 |
| three | 幻想 FC |

在一个关系数据库中，就像上面的例子一样，表明 c 罗曾在皇马和曼联效力的唯一方法是有一个包含两个球队名字的第二个(细节)表，并在主表中添加一个额外的列，其中有一个唯一的标识记录的 PlayerId。

这个 PlayerId 列也将存在于细节表中，它将负责将细节记录与主表中的相应记录链接起来。这是标准的主-细节关系数据库关系。

在文档数据库中，这种主-细节关系被表示为具有嵌套属性的属性。让我们探索一下这将如何寻找球员 c 罗的记录。

表 1-f:具有主-细节嵌套属性的文档

| 文件 | 文档数据 |
| Two | {“名字:“克里斯蒂亚诺”，“姓氏”:“罗纳尔多”，【年龄】:31 岁，“团队”:[{“球队”:“皇马”},{“球队”:“曼联”}]} |

我们可以看到，在传统关系数据库的细节表中存储的团队现在存储在一个名为 teams 的数组中，其中每个团队都是一个嵌套的 JSON 对象，该对象包含一个名为 team 的子属性。

基本上，主-细节关系现在被描述为一个 JSON 对象数组。然而，在这种情况下，仅仅因为主-细节关系可以很容易地描述为 JSON 对象的数组，并不意味着它总是必须这样描述。

## 何时使用文档数据库

非关系数据库的优势和好处在于，您可以自由地以最适合您的应用和业务需求的任何方式实现和表示主-细节记录之间的关系。

在文档数据库中，重复一些数据以便每个文档都有它需要的数据而不必定位其他文档也是很常见的。如果数据重复太多，那么您可以选择在不同的文档中组织重复的数据，类似于传统的关系数据库。在任何情况下，您都可以自由地将您的 JSON 文档的结构组织成最适合您的需求和应用的结构。

本质上，文档数据库让您可以自由地以最适合您需求的方式对数据进行建模。

尽管有这种灵活性，但重要的是要理解文档数据库最适合处理可以组织成丰富的分层文档的数据，这些文档几乎可以完全独立。

如果您发现自己正在为包含许多相关文档或具有平面结构的文档的数据库建模，这表明文档数据库可能不是您的应用的最佳选择。

当您需要一个可扩展的数据库时，文档数据库是一个很好的选择。文档数据库可以横向扩展的主要原因是，它们不会对数据强加复杂或严格的规则，而且设计简单而精简。

另一方面，关系数据库更适合处理不一定需要横向扩展的复杂需求。

## 为什么 DocumentDB？

DocumentDB 是微软高度可扩展的文档数据库 API，运行在 Azure Cosmos DB 上。尽管它具有典型文档数据库的所有特征，但它也具有其他任何文档数据库都不具备的特性。让我们来探索这些特性。

使用 DocumentDB，与其他需要明确定义索引的文档数据库不同，一旦文档被添加到数据库中，所有属性都会自动建立索引。这允许您搜索文档层次结构中的任何属性，无论它嵌套有多深。

此外，文档可以使用一种特殊的 SQL 风格进行搜索，任何有 SQL 经验的人都可以以直观的方式轻松掌握并与之相关联——这是 DocumentDB 自己的 SQL 方言。

因为 DocumentDB 运行在 Azure Cosmos DB 上，所以它提供了一个服务器端环境，您可以在该环境中运行 JavaScript 代码，该代码可以用完整的事务处理更新多个文档。这是确保多个文档之间数据一致性的一种非常好且简单的方法。

此外，DocumentDB 允许根据应用的要求进行性能调整，例如提高吞吐量、索引和一致性。通过 Azure Portal 更改性能层，可以立即提升或降低吞吐量。

尽管 DocumentDB 会自动为每个属性编制索引，但您仍然可以对系统进行微调，以排除任何不需要编制索引的属性或文档，这甚至有助于在非常特定的情况下提高性能。

尽管 DocumentDB 支持传统的强一致性和最终一致性(与分布式数据系统略有不同的形式)，但它还提供了两个额外的选项，让您可以更好地控制性能和一致性之间的权衡。

所有这些功能都被很好地打包为一个完全受管理且可大规模扩展的平台即服务(PaaS)解决方案，非常易于设置和开始使用。没有需要安装的东西，没有需要管理的操作系统或更新，也没有需要设置的副本。

通过 Azure 门户，您可以使用浏览器和 Azure 订阅，在几分钟内启动并运行 DocumentDB。花点时间正确设置您的 Azure 订阅。

听起来很令人兴奋，所以让我们用一些额外的细节来探索其中的一些特性。

## 丰富的 SQL 风格的查询

DocumentDB 最好的特性之一是它的本地查询语言非常类似于 SQL。对于那些与。NET，还有一个 LINQ 提供商。

尽管 DocumentDB 的调味查询是用 SQL 编写的，但它们深深植根于 JSON 和 JavaScript 语义。它们允许您查询文档中的分层嵌套数据和数组，还可以共享查询结果的自定义投影。我们来看一个例子。

代码清单 1-a:一个文档数据库 SQL 风格的查询

```cs
  --
  SQL flavored query.
  SELECT ch.First, ch.Last
  FROM Players AS p
  JOIN ch IN
  p.children
  WHERE p.Age = 31

```

在这个有味道的 SQL 查询示例中，我们正在做一些事情。`JOIN`子句基本上允许 DocumentDB 遍历所有嵌套在 Players 文档中的`children`(属性)。

`WHERE`子句通过检查`Age`属性值等于 31 的文档进行过滤。请注意，虚线符号用于表示文档中的属性。虚线符号可以嵌套在文档的层次结构中。

因为在`SELECT`子句中，我们选择了两个属性而不是一个`SELECT *`，所以 DocumentDB 会投影一个新的 JSON 对象，该对象只包含被查询的属性，而不是整个文档。

一旦文档被插入到 DocumentDB 中，它几乎可以立即搜索，因为它是自动索引的。可以调整这种索引行为。然而，通常没有必要。

## 客户端开发

DocumentDB 提供了各种 SDK，允许从您首选的开发平台轻松集成。有几种最常见的开发平台的 SDK，例如。NET、Node.js、JavaScript、Java 和 Python。

它与其他平台没有什么不同，因为它还提供了一个 REST/HTTP API，只要 HTTP 请求的标头包含有效的身份验证信息并且请求指向正确的 HTTP DocumentDB 资源，就可以使用该 API。

使用 REST/HTTP API 是与 DocumentDB 交互的最原始的方式；当您需要将大部分注意力集中在应用的逻辑上时，这可能会变得非常乏味。因此，我们将重点使用。NET SDK 在做客户端开发的时候。

如果您的开发平台没有 SDK，您可以使用 REST/HTTP API。不过你也要联系 [Azure 支持](https://azure.microsoft.com/en-us/support/options/)，让他们知道你用的是什么平台，把你的反馈提供给他们。希望他们能够考虑您的意见，并在他们的路线图中包含您的开发平台的 SDK。Azure 团队非常活跃，并致力于该平台，因此如果您的平台没有 SDK，很可能是因为还没有人要求它。

## 服务器端开发

DocumentDB 是一个服务器沙箱环境，它让您能够在数据所在的内部执行逻辑。DocumentDB 中的服务器端逻辑可以打包成存储过程和触发器以及用户定义函数(UDFs)，这在使用 Oracle 和 SQL Server 等关系数据库系统时非常熟悉。

然而，用 DocumentDB 编写的服务器端逻辑和用传统关系数据库编写的服务器端逻辑之间有细微的区别。在 DocumentDB 中，服务器端逻辑是用 JavaScript 而不是 SQL 编写的，这使得它成为处理 JSON 对象的完美伴侣。

DocumentDB 通过支持事务脚本在数据库引擎中的本地执行，将 JavaScript 作为一种现代 SQL。

因为 DocumentDB 是一个完全托管的服务，所以它不能允许性能不佳的脚本无限期运行，因为这可能会危及整个服务的完整性。因此，它实施了一个被称为有界执行的范例，这个范例基本上决定了在超时之前您的逻辑可以运行多长时间。

所有服务器端逻辑执行都是完全事务性的，这意味着如果您更新了一些文档并发生了错误，或者您的一个脚本在实际完成之前由于有限的执行而超时，那么到那时为止的所有更新都会自动回滚。如果您的服务器端代码成功完成，那么所有更新都保证一起提交。这使得文档数据库成为一个更有吸引力的选择。

## 可扩展性

对于 NoSQL 数据库，可扩展性是成功的关键，而 DocumentDB 提供了这一点。它已经是 Xbox 和 Office OneNote 等服务的后端选择，这些服务依赖 DocumentDB 来存储包含数十万亿字节 JSON 文档的数据库，用户超过 100 万，正常运行时间可用性为 99.9%。

让您了解 DocumentDB 可以扩展的范围:它可以增长到您能承受的程度，也可以增长到 Azure 数据中心可用硬件的极限，无论您首先达到哪个极限。这是一个深刻的陈述，清楚地表明了 DocumentDB 可以处理什么以及它可以扩展到什么程度。它也是创建宇宙数据库的基础。

简而言之，DocumentDB 可以通过数千个节点大规模扩展到数百 TB 甚至数千兆字节。它可以上下扩展，也可以向外扩展。

它能够无缝地上下扩展，这由计算能力和存储容量的组合组成。

DocumentDB 还能够通过添加更多集合来横向扩展。文件的集合本质上可以看作是一个尺度单位。如果您的数据库增长超过 10 GB，那么您可以通过简单地添加更多集合，然后跨多个集合对数据进行分区来进行横向扩展。

## 一致性

DocumentDB 的另一个重要特性是它调整一致性的能力。通常在性能和一致性之间有一个折衷。

基本上，强一致性会降低读写速度，最终的一致性并不总是返回最新的数据。通过强大的一致性，当编写器对数据库进行更改时，您可以获得一致的查询结果，但是您在性能上付出了代价，因为所有查询都必须等到所有副本都用最新的更改进行了更新，这显然会降低速度。

相反，最终的一致性为您提供了最好的性能，但是您不能完全依赖查询结果。他们可能会返回与其他用户可能正在更新的数据不完全一致的数据，因为并非所有副本都必须是最新的。

DocumentDB 支持这两种一致性方法和三种附加方法，这三种方法在某种程度上处于强一致性和最终一致性的中间。这三个额外的方法被称为有界过时、会话和一致前缀。

有界过时允许您容忍不一致的查询结果，方法是保证这些结果在指定的时间段内至少足够一致。

会话一致性实际上是 DocumentDB 中使用的默认一致性方法，可以认为是一种混合体验。作者保证他们自己编写的数据具有很强的一致性，而其他所有人都以最终的一致性进行操作。

一致的前缀保证了在没有任何进一步写入的情况下，组内的副本最终会收敛。配置了一致前缀一致性的 Azure Cosmos DB 帐户可以将任意数量的 Azure 区域与其 Azure Cosmos DB 帐户相关联。

DocumentDB 允许调整和更改一致性，让您可以灵活地使用最适合您的业务需求的方法。

关于使用 DocumentDB API 在 Azure Cosmos DB 中可调数据一致性级别的更多信息，可以在[这里](https://docs.microsoft.com/en-us/azure/documentdb/documentdb-consistency-levels)找到。

## 成本

在引入 Cosmos DB 之前，当 DocumentDB 作为独立服务提供时，成本基于预设的层和集合。

在宇宙数据库之前的文档数据库中，集合不仅是一个规模单位，而且与成本和定价直接相关。您将为每个收藏付费，每个收藏的存储容量高达 10 GBs。

随着 Azure Cosmos DB 的引入，基于集合和层的组合的旧定价模式变得无关紧要，并且没有完全的弹性。

旧的 DocumentDB S1、S2 和 S3 性能级别没有提供 DocumentDB API 集合现在提供的与 Cosmos DB 一起前进的灵活性。这是因为在 S1、S2 和 S3 的性能级别中，吞吐量和存储容量都是预先设置的，不提供弹性。

Azure Cosmos DB 现在提供了定制吞吐量和存储的能力，为您提供了更大的灵活性来随着应用需求的变化进行扩展。关于这个话题的更多信息可以在[这里](https://docs.microsoft.com/en-us/azure/documentdb/documentdb-performance-levels#why-retired)找到。

## 总结

在本章中，我们很快了解了一些最突出的 NoSQL 文档数据库特征，特别是关于 DocumentDB 及其与传统关系数据库的比较。

特别是，我们重点描述了 DocumentDB 是如何从头开始设计的，以横向扩展和无模式的分层 JSON 文档，不像传统的表格数据库表那样需要模式和复杂的连接来拼凑。

我们还快速描述了 DocumentDB 如何实现跨文档的即时搜索，以及当文档添加到集合中时，如何自动为每个属性编制索引，从而允许您使用熟悉的类似 SQL 的语法快速轻松地查询它们。

此外，我们还讨论了如何通过各种特定于平台的 SDK 和使用带有完全事务处理的 JavaScript 来实现客户端和服务器端编程。

最后，我们描述了 DocumentDB 如何允许可调一致性和支持弹性扩展。我们还简单谈了一下成本。

这为后面的章节奠定了基础，让我们有了一个坚实的起点，并对 DocumentDB 能让我们完成的事情有了一个高度的了解。在接下来的几章中，我们将重点深入探讨 DocumentDB 的每一个特性，并通过编写一些代码来探索其中的每一个特性。感谢阅读！