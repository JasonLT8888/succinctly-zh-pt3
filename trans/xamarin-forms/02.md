# 第二章平台间代码共享

Xamarin。表单允许您从一个 C#代码库中构建运行在安卓、iOS 和 Windows 上的应用程序。这是可能的，因为在它的核心，Xamarin。表单允许平台间共享用户界面的所有代码和非特定平台的所有代码。平台之间共享代码有不同的方式，各有利弊。本章解释了 Xamarin 中可用的代码共享策略。表单，突出它们的特征，以便您更容易决定哪种策略更适合您的解决方案。

在第 1 章中，我解释了如何创建 Xamarin。Visual Studio 2017 中的表单解决方案，它由四个项目组成:三个平台项目(安卓、iOS 和 UWP)，以及一个允许平台间共享代码的项目。通过这种方法，开发人员可以共享用户界面的所有代码以及未耦合到每个平台的 API 的所有代码，从而最大限度地提高代码重用，并简化从单个 C#代码库中创建三个不同的本机应用程序的过程。在那个解释中，我简单介绍了一下。NET 标准作为允许共享代码的项目类型。然而，Xamarin。表单允许以两种不同的方式在平台之间共享代码:共享项目和。NET 标准库。本章包含对这两种代码共享策略的全面讨论，提供了有关的更多信息。NET 标准项目类型。

| ![](img/tip.png) | 注意:在 3.0 版本之前。NET 标准没有作为 Xamarin 的代码共享选项包含在 Visual Studio 中。表单，它提供了可移植类库(PCL)模型。当创建新的 Xamarin 时，这在 Visual Studio 2017 中不再可用。表单项目，因此本书不会涉及。 |

[。NET 标准](https://docs.microsoft.com/en-us/dotnet/standard/net-standard)为所有的。NET 开发平台，如。. NET 框架。NET Core 和 Mono 必须实现。这允许统一。NET 平台并避免未来的碎片化。通过创建一个. NET 标准库，您将确保您的代码可以在任何。NET 平台，不需要选择任何目标。这也解决了可移植库的一个常见问题，因为每个可移植库可以针对一组不同的平台，这意味着库和项目之间潜在的不兼容性。微软有一篇关于 T3 的有趣的[博文。NET 标准及其目标和实现将澄清对该规范的任何疑问。](https://blogs.msdn.microsoft.com/dotnet/2016/09/26/introducing-net-standard/)

在撰写本文时，版本为。NET 标准是可用的，新的 Xamarin。表单项目依赖于此版本。。NET 标准库当然不是 Xamarin 独有的。事实上，它们可以用于许多其他开发场景。例如，. NET 标准库可以用来在 WPF 项目和 UWP 项目之间共享模型-视图-视图模型架构。

最重要的特征。NET 标准库包括:

*   他们产生一个编译好的，可重用的。dll 程序集。
*   它们可以引用其他库，并具有依赖关系，如 NuGet 包。
*   它们可以包含用户界面定义的 XAML 文件和 C#文件。
*   它们不能公开利用特定 API 的代码，这些 API 在特定目标的所有平台上都不可用。NET 标准版。
*   当您需要实现诸如 MVVM、工厂、带有依赖注入的控制反转(IoC)和服务定位器等架构模式时，它们是更好的选择。
*   关于 Xamarin。表单，它们可以使用服务定位器模式来实现抽象，并通过平台项目调用平台特定的 API(这将在第 8 章中讨论)。
*   它们更容易进行单元测试。

例如，只能使用。NET 标准库，用于 WPF 和 UWP 应用程序访问设备的位置传感器(如果两种应用程序类型都支持该组件)。通常，您会手动创建一个. NET 标准库项目，然后向解决方案中的其他项目添加必要的引用。就 Xamarin 而言。表单，而是在创建新项目时决定代码共享策略(参见图 4)，然后 Visual Studio 2017 将自动生成一个. NET Standard 项目，该项目由解决方案中的平台项目引用，并且依赖于 Xamarin。表单 NuGet 包。

| ![](img/note.png) | 注:在本电子书的所有示例中，我将使用。NET Standard 作为代码共享策略的原因如下:它使其他库的使用和管理变得更加容易，对于需要更复杂架构的现实世界项目来说，它是更好的选择。 |

共享项目以及。NET 标准库，不是 Xamarin 特有的，已经存在很多年了。共享项目本质上是可以与其他项目共享的文件的松散分类。以下是共享项目最重要的特征列表，也强调了与. NET 标准库的区别:

*   它们不会产生编译过的、可重用的。dll 程序集。
*   它们不能引用其他库，并且有依赖关系，例如 NuGet 包。
*   它们可以包含用户界面定义的 XAML 文件和 C#文件。
*   它们可以包含特定于平台的代码，可以使用条件编译和预处理器指令。

要选择共享项目作为代码共享策略，在**新跨平台 App** 对话框中(见图 4)，在**代码共享策略**组中选择**共享项目**。当解决方案在解决方案资源管理器中准备就绪时，您将看到类似于图 18 的共享项目。

图 18:Xamarin 中的共享项目。表单解决方案

这里需要注意的一点是，平台项目(安卓、iOS 和 UWP)有对共享项目的引用，但共享项目不能有引用或依赖。此外，共享项目的属性没有项目级属性；相反，您只能访问它们包含的单个文件的属性。毫不奇怪，解决方案资源管理器中没有共享项目的“属性”或“引用”节点。共享项目可以包含无数不同的文件和资源，包括用户界面的 XAML 文件和 C#代码文件。这是可能的，因为共享项目没有编译；相反，编译器会在构建整个解决方案时解析源文件和资源。因为共享项目不引用任何库，所以可能很难记住可以在 C#中使用的类型和成员。幸运的是，IntelliSense 会提供帮助，在您键入时显示什么可用(什么不可用)，如图 19 所示。

图 19:智能感知显示了可用的类型

共享项目的最大好处是，它们允许编写特定于平台的代码，而不需要像使用 NET Standard 库那样使用服务定位器之类的模式。这是使用预处理器指令来完成的，如`#if`、`#elif`、`#else`和条件编译符号，如代码清单 1 所示。

代码清单 1

```cs
  private string GetFolderPath()
  {
      string path = "";

      #if __ANDROID__
          path = Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments);  
      #elif __IOS__
          path = Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments);
      #elif WINDOWS_PHONE
          path = Windows.Storage.KnownFolders.DocumentsLibrary.Path;
      #endif
      return path;
  }

```

如您所见，您可以简单地使用预处理器指令检查应用程序运行的平台，然后编译器将解析适当的平台特定代码，而无需处理其他模式的复杂性。每个平台都由项目属性的构建选项中定义的条件编译符号表示。表 1 总结了 Visual Studio 2017 中可用的符号及其代表的平台。

表 Xamarin 中的条件编译符号。形式

| 标志 | 描述 |
| --- | --- |
| `__ANDROID__` | 代表安卓平台 |
| `__IOS__` | 代表 iOS 平台 |
| `WINDOWS_PHONE` | 代表通用视窗平台、视窗 8.1 和视窗手机 8.1 平台。Xamarin 不再支持 Windows 8.1 和 Windows Phone 8.1。表格 3.x。 |
| `__TVOS__` | 代表苹果电视操作系统平台 |
| `__WATCHOS__` | 代表苹果手表操作系统平台 |
| `NETFX_CORE` | 代表。NET 核心平台 |

使用条件编译符号和预处理器指令的平台特定代码的一个有趣的例子是 [SQLite.cs](https://github.com/praeclarum/sqlite-net/blob/master/src/SQLite.cs) 文件，它针对 C#中流行的 SQLite 数据库实现数据访问。基于共享项目和前述方法的完整示例解决方案可从官方 Xamarin 文档中获得，并被称为 [Tasky](https://github.com/xamarin/mobile-samples/tree/master/Tasky) 。它展示了如何创建一个简单的待办事项移动应用程序。

可以选择用代码清单 1 中的方法编写特定于平台的代码当然很有吸引力，但是您应该更喜欢。NET 标准库，至少在以下情况下:

*   您需要访问许多特定于平台的资源，并且您的代码可能变得非常难以维护。
*   您需要实现基于一个或多个模式的架构。在这种情况下，共享项目不仅不是最好的选择，而且拥有多个可移植库也很常见，这也使得团队更容易处理解决方案的不同部分。
*   您希望高效地对代码进行单元测试。

前面提到的几点，以及我在关于可移植库的部分中所做的考虑，应该会进一步阐明您会发现基于示例的原因。NET 标准库，而不是本电子书中的共享项目。

本章介绍了 Xamarin 可用的代码共享策略。窗体可以用来共享用户界面文件和独立于平台的代码，例如。NET 标准库和共享项目。。NET 标准库生成可重用的程序集，允许实现更好的体系结构，并且不能包含特定于平台的代码。共享项目可以包含带有预处理器指令和条件编译符号的特定于平台的代码，但是它们不会产生可重用的程序集，并且如果它们访问许多本机资源，代码维护会更加困难。

。NET 标准库代表了跨平台代码共享的现在和未来，基于一组正式的 API 规范，它们确保您的代码将在支持所选版本的所有平台上运行。NET 标准。假设。NET 标准库是首选，在接下来的章节中，您将开始编写代码和构建跨平台用户界面。