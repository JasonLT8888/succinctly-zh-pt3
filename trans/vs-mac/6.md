# 第 6 章用 Git 进行版本控制

Visual Studio for Mac 通过与流行的版本控制引擎(如 Subversion 和 Git)集成，支持团队在源代码上的协作。毫无疑问，Git 是两者中使用最多的，因此我将使用 Git 来演示 Visual Studio 对 Mac 的协作能力。Subversion 还将提供大部分功能。

## 准备样本库

Visual Studio for Mac 可以利用所有最先进的 Git 特性来处理源代码，例如合并、分支、查看文件、查看差异和作者等。为了理解它是如何工作的，我们首先需要创建一个远程存储库，GitHub 将是首选的服务。

用你的账号登录 [GitHub](https://github.com) 。如果你没有，你可以免费注册。点击**新建库**，项目名称进入**增量世界**，如图 60 所示。

![](../Images/image069.png)

图 60:为新项目创建一个 Git 存储库

准备好之后，点击**创建存储库**。一旦创建了存储库，您将进入一个页面，在那里您将看到新存储库的 URL，其形式如下:

https://github.com/YourAccount/IncrementalHelloWorld.git

**YourAccount** 代表您在 GitHub 上使用的用户名。保存此网址，因为它将很快被使用。现在回到 Visual Studio for Mac 并创建一个新的。NET 核心控制台项目名为**增量世界**，但不启用 Git 版本控制，因为该项目将与之前创建的远程存储库相关联。原因是，目前，如果本地存储库还没有匹配的远程存储库，Visual Studio for Mac 对发布本地存储库的支持有限。

项目完成后，右键单击解决方案面板中的解决方案名称，然后选择**版本控制** > **发布到版本控制**。此时，出现**选择存储库**对话框。这里需要指定远程存储库的细节，包括版本控制引擎，在这种情况下是 **Git** 。输入存储库 URL 和您的帐户名，如图 61 所示。

![](../Images/image070.png)

图 61:输入存储库的详细信息

端口号因使用的协议而异。例如，对于 https，端口是 443。当您单击**确定**时，Visual Studio for Mac 将要求您确认远程发布项目，并将请求您的 GitHub(或您选择的任何其他 Git 服务)凭据。几秒钟后，该项目将在本地和远程可用。

## 处理文件更改

在 **Program.cs** 文件中，删除`using`指令和`namespace`关键字之间的空白，然后在`Console.WriteLine`语句后添加以下行:

`Console.ReadLine();`

在这一行中，您引入了一个变化，因此，本地存储库和之前更新的远程存储库之间有所不同。在代码编辑器的底部，单击**更改**选项卡。您将能够比较本地文件和远程文件。用绿色突出显示的代码行代表新代码，而用红色下划线突出显示的代码行代表删除的代码。图 62 显示了差异。

![](../Images/image071.png)

图 62:查看文件更改

使用**作者**选项卡(见图 63)，您可以看到一段特定代码的作者，以及提交细节。如果代码尚未提交，作者仍会出现在当前正在进行的代码附近的视图中。

![](../Images/image072.png)

图 63:查看代码作者

使用**日志**选项卡，您可以查看提交中对每个文件所做编辑的详细信息。请看图 64。在左侧的框中，您将看到提交列表。当有更多提交可用时，您可以单击提交，并在选项卡的右侧查看其详细信息。此外，当您选择提交时，选项卡底部的区域会显示已提交的文件列表以及它们经过的编辑。

![](../Images/image073.png)

图 64:查看提交日志

**合并**选项卡是关于合并分支的，将在本章后面讨论。现在，假设您想要提交之前所做的更改。选择**版本控制** > **查看解决方案并提交**。如图 65 所示，您将看到有变化的文件列表。在这种情况下，Program.cs 文件有一个黄色图标，这意味着它已被编辑，并且黄色覆盖图标在该文件的解决方案面板中也可见。新的解决方案文件可以通过绿色覆盖图标识别，而删除的文件可以通过蓝色覆盖图标识别。

![](../Images/image074.png)

图 65:提交前检查文件更改

如果您展开文件，您将看到代码更改的预览，包括新的和删除的代码。别忘了输入评论，然后点击**提交**。此时，您将看到**提交文件**对话框(见图 66)。您可以在这里选择自动将更改推送到远程存储库的选项，因此选择**提交**后将更改推送到远程存储库复选框，然后单击**提交**。

![](../Images/image075.png)

图 66:提交文件对话框

| ![](../Images/note.png) | 注意:如果您在第一次提交时收到一个错误，说推送操作无法完成，这可能是因为 Visual Studio 再次需要您的 Git 凭据。如果出现这种情况，请选择版本控制>推送更改。Visual Studio 将询问您的 Git 凭据，并将任何未保存的更改推送到远程存储库。然后再次承诺，这一次它应该会起作用。 |

一旦提交了代码，存储库就会更新到代码的最新版本。如果您选择自动推送更改，远程存储库也是最新的。如果没有选择该选项，可以选择**版本控制** > **推改**。当您希望其他开发人员能够处理最新版本的源代码时，请记住始终推送您的更改。

## 与其他开发人员合作

使用版本控制服务不仅对于保存项目工作的历史很重要，还因为它简化了开发团队在同一项目上协作的方式。本节描述了 Visual Studio 中支持 Git 集成的可用协作工具。

### 克隆存储库

当您想要处理与 Git 这样的版本控制服务相关联的项目时，您需要获取源代码的副本，处理代码，最后，您将代码重新提交给服务器。在 Git 术语中，获得源代码的副本被称为克隆存储库。

在 Visual Studio for Mac 中，您可以通过**版本控制** > **签出**来克隆存储库。执行此操作时，将出现**选择存储库**对话框(见图 67)。在这里，您可以指定现有远程存储库的 URL、您的 Git 用户帐户和其他属性，就像您将本地存储库推送到它的远程对等存储库时所做的那样。

![](../Images/image076.png)

图 67:克隆存储库

单击**签出**开始将存储库克隆到**目标目录**字段中指定的文件夹。显然，您可以选择不同的路径。一旦存储库被克隆，您将能够像平常一样打开解决方案文件。

### 分支合并

Visual Studio for Mac 内置了对创建和管理本地和远程分支的支持。要使用分支机构，选择**版本控制** > **【管理分支机构** **和远程**。当 Git 存储库配置对话框出现时(见图 68)，您将看到当前项目的分支列表。在之前创建的示例项目中，只有主分支可用。如果点击**新建**，可以在**分支属性**对话框中创建一个新的分支，在图 68 中仍然可见。

![](../Images/image077.png)

图 68:创建分支

输入分行名称，然后点击**确定**。对于当前的例子，我正在创建一个名为**开发**的分支。或者，您可以通过使用**跟踪分支**复选框并从下拉列表中选择分支来跟踪现有的远程分支。新分支将在 **Git 存储库配置**对话框中可见。此时，可以点击**切换到分支**将选中的分支设置为活动分支。准备好之后，点击**关闭**。现在您有了一个新的分支，用下面的代码替换`Main`方法的代码，以便引入文件更改。

代码清单 4

```
        static void Main(string[] args)
        {
            Console.WriteLine("Type something:");
            string input = Console.ReadLine();
            Console.WriteLine(input);
        } 

```

按照前面的经验，检查并提交您的代码。图 69 显示了文件变化是如何出现的。

![](../Images/image078.png)

图 69:查看新分支的变化

准备就绪后，单击**提交**，并确保将您的更改推送到远程存储库。现在切换到主分支。作为快捷方式，您可以在解决方案面板中右键单击解决方案名称，然后选择**切换到分支** > **主**。现在选择**版本控制** > **合并分支**。当对话框出现时(见图 70)，您可以选择将要合并到当前分支的分支，在这种情况下是开发。我们先选择**开发**，然后**合并**。

![](../Images/image079.png)

图 70:合并分支

源代码将相应更新。当您对您的更改满意时，选择**版本控制** > **推送更改**，这样代码也将更新到远程分支。

### 解决冲突

合并分支时，可能会发生一些冲突。在这种情况下，您将能够使用代码编辑器的**合并**选项卡，其中您将在左侧看到本地版本，在右侧看到远程版本，并在窗口中心预览代码将如何显示。您可以通过选择要包含在合并过程中的代码部分来解决冲突。

### 同步分支

如果有更多的人在同一个分支上工作，及时了解代码的最新编辑是很重要的。借助**版本控制** > **更新解决方案**，当前分支将与远程分支同步。

### 关于隐藏的提示

用于 Mac 的 Visual Studio 还支持*staps*。有了 stashes，Git 允许将您编辑的文件保存在一堆未完成的更改中，您可以随时重新应用。当您还没有完成您的工作，并且您希望拥有一个远程的变更副本而不影响提交的存储库时，这将非常有用。如果您有使用 Team Foundation Server(现在称为 Azure DevOps)的经验，这类似于搁置操作。本章不会讨论 stasshes，但是 Visual Studio for Mac 在版本控制菜单中提供了**stasshes**、**Pop stasshes**和**管理 stasshes**命令，帮助您使用该功能。

## 章节总结

通常情况下，您需要与其他开发人员就项目进行协作。Visual Studio for Mac 集成了对 Subversion 和 Git 版本控制服务的支持，但对 Git 来说，这种集成甚至更强大。一旦您的项目处于版本控制之下，您就可以轻松地看到文件更改并提交您的工作，这样其他开发人员就可以通过首先克隆存储库，然后创建和合并分支来处理项目。所有工作都可以在 Visual Studio 中完成，Visual Studio 在代码编辑器和特定对话框中提供了方便的集成选项卡。到目前为止，您已经看到了大量的生产力功能，但是 Visual Studio for Mac 提供了更多功能。事实上，它可以定制以更好地满足您的偏好，并且可以扩展，以便使用第三方工具来增强其功能。