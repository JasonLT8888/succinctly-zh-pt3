# 第六章诊断学

任何生产环境中最重要的事情之一就是跟踪任何错误并维护日志。如果应用程序表现出一些奇怪的行为，这就派上了用场，因为我们不能直接调试或跟踪问题。可能会出现外部链接断开或某个外部服务器不可用的情况。ASP.NET 网络钩子为我们提供了一种使用网络钩子处理程序诊断应用程序的方法。在本章中，我们将讨论应用程序的日志记录和调试。

### 伐木

日志为我们提供了应用程序中所有奇怪异常、错误或隐藏问题的内部视图，在任何生产环境中都很有帮助。

应用程序或软件的编写应该能够有效地报告问题，而日志记录是报告问题的最佳方式。ASP.NET 网络钩子为日志记录提供了固有的支持。

| ![](../Images/tip.png) | 提示:系统。跟踪是 ASP.NET 网络钩子在内部写日志的默认方法。 |

内部有一个 TraceLogger.cs 类，它实现了 ILogger 接口并写入日志。这是以这样一种方式实现的，即任何人都可以在使用 Log4Net 或 NLog 等框架的同时实现日志系统。

在本书中，我们将使用 Azure 应用程序作为示例应用程序。让我们讨论如何在 Azure 应用程序中实现日志记录。

在 Azure 上，启用日志记录后，所有日志都自动可用。以前面几章中讨论的任何一个例子为例，我们将我们的应用程序部署为 Azure web 应用程序。

在本节中，我们将讨论通过使用 Azure 门户启用日志的步骤，也可以直接从 Visual Studio 中启用。

Azure 提供 web 服务器诊断和应用程序诊断。通过应用程序诊断，我们可以查看或检索有助于跟踪各种问题的日志。

让我们看看如何启用应用程序诊断:

使用有效凭据登录 Azure 门户。转到**网络应用程序**并点击您的应用程序(在我们的案例中是 ActivityTrackerSampleAPP)。

| ![](../Images/tip.png) | 提示:如果你没有 Azure 账号，可以在这里创建一个免费的[。](https://azure.microsoft.com/en-in/free/) |

![](../Images/image046.png)

图 33:网络应用程序- Azure 门户

选择**诊断日志**，启用应用诊断，如图 34 所示。

![](../Images/image047.png)

图 34:启用应用程序日志

在 Azure 门户的帮助下，您可以选择详细来捕获所有内容(也可以根据您的选择选择信息、警告或错误级别)；这是启用诊断日志的简单方法。

| ![](../Images/note.png) | 注意:要了解更多关于启用诊断的信息，请参考这里的。 |

在本节中，我们将讨论使用 Visual Studio 启用应用程序日志记录。所有示例都使用 Visual Studio 2015。

启动 Visual Studio 并打开我们在第 3 章中创建的 ActivityTracker 应用程序。该应用程序已经发布到 Azure，如果您跳过了第 3 章，您可以通过转到第 3 章、打开应用程序并通过 Azure 发布来使用 Bitbucket 存储库中的示例应用程序。

| ![](../Images/tip.png) | 提示:建议使用具有提升的管理员权限的 Visual Studio。 |

从 Visual Studio 中，打开服务器资源管理器并展开应用程序服务节点，右键单击 ActivityTrackerSampleApp(我们已经发布了此应用程序)，然后单击查看设置。

| ![](../Images/note.png) | 注意:如果您尚未登录，Visual Studio 将提示您使用 Azure 订阅凭据登录。 |

![](../Images/image048.jpg)

图 35:启用应用程序日志记录- Visual Studio

在“视图设置”页面的“配置”选项卡下，您可以启用日志记录。从应用程序日志(文件系统)下拉菜单中选择**详细**，点击 **S** 保存，启用所有级别的日志记录。应用程序现在可以写日志了。

#### 实现或重定向自己的日志实现

如前所述，ASP.NET WebHooks 使用 System.Diagnostics.Trace 在内部写入日志。但是如果您想使用一些其他的日志框架，比如 Log4Net 或 NLog，我们只需要提供 ILogger 接口的实现，并简单地使用任何依赖注入引擎进行注册。

### 调试

当我们将应用程序部署到 Azure 时，我们希望调试我们的生产或部署代码来跟踪各种问题。这需要远程调试(其中我们附加我们的生产环境，并在本地机器上使用 Visual Studio 进行调试)。当您需要深入代码以修复问题时，这一点非常重要。

*在本节中，我们将采用第 03 章中开发的示例应用程序。如果尚未部署，您现在可以将应用程序部署到 Azure。*

首先，使用 Visual Studio 打开 ActivityTracker 示例应用程序(在第 3 章中创建)。打开服务器资源管理器，展开**应用服务**节点，右键单击 ActiviTyTrackerSampleApp，然后选择附加调试器。

| ![](../Images/note.png) | 注意:在附加进程开始调试之前设置断点。 |

只要选择**附加调试器**，Visual Studio 就开始应用调试器设置，并使用应用程序 URL 调用网络浏览器。现在，向您添加了 WebHook 接收器的存储库推送一些更改(参见第 3 章)。

![](../Images/image049.jpg)

图 36:调试应用程序

Bitbucket 一触发推送事件，断点就命中了，调试时可以看到数据的价值和逻辑的流向。

在创建或自定义现有代码时，直接使用源代码进行调试非常重要。这允许你直接调试 ASP.NET 网络钩子的整个源代码。为了实现这一点，您将必须遵循 ASP.NET 网络钩子的[官方文档](https://docs.asp.net/projects/webhooks/en/latest/diagnostics/debugging.html)中提到的几个步骤。

### 结论

在这一章中，我们看了诊断，也讨论了日志和调试的重要性。我们已经调试了一个实时应用程序，并详细研究了如何从 Azure 获取应用程序日志。